using System;
using System.Globalization;
using System.Net;
using System.Net.Sockets;
using System.Text;
using System.Threading;
using Navtrack.Listener.Helpers;

namespace Navtrack.Listener.DeviceSimulator;

class Program
{
    static void Main(string[] args)
    {
        SimulateMeitrack();
    }

    private static void SimulateTeltonika()
    {
        TcpClient tcpClient = new();
        tcpClient.Connect(IPAddress.Loopback, 7002);
        NetworkStream networkStream = tcpClient.GetStream();

        networkStream.Write(HexUtil.ConvertHexStringToByteArray("000F333532383438303236333839393631"));
        networkStream.Write(HexUtil.ConvertHexStringToByteArray(
            "00000000000003E108120000011733FAD2C80000000000000000000000000000000000080301014501F00003B60000422F5343004002C700000000F100005852000000011733FAAB2C0000000000000000000000000000000000080301014501F00003B60000422F7A43004602C700000000F100005852000000011733FA83720000000000000000000000000000000000080301014501F00003B60000422F6E43003D02C700000000F100005852000000011733FA5BD60000000000000000000000000000000000080301014501F00003B60000422F7843004902C700000000F100005852000000011733FA343A0000000000000000000000000000000000080301014501F00003B60000422F6D43004D02C700000000F100000000000000011733FA0C940000000000000000000000000000000000080301014501F00003B60000422F7643004302C700000000F100000000000000011733F9E4EE0000000000000000000000000000000000080301014501F00003B60000422F7B43004202C700000000F100000000000000011733F9BD520000000000000000000000000000000000080301014501F00003B60000422F7E43004602C700000000F100000000000000011733F995990000000000000000000000000000000000080301014501F00003B60000422F7543004102C700000000F100005852000000011733F96DE80000000000000000000000000000000000080301014501F00003B60000422F6743003E02C700000000F100005852000000011733F9464C0000000000000000000000000000000000080301014501F00003B60000422F6E43004A02C700000000F100005852000000011733F91E9C0000000000000000000000000000000000080301014501F00003B60000422F6943004602C700000000F100000000000000011733F8F6F60000000000000000000000000000000000080301014501F00003B60000422F7643004602C700000000F100000000000000011733F8CF5A0000000000000000000000000000000000080301014501F00003B60000422F6443004902C700000000F100000000000000011733F8A7B40000000000000000000000000000000000080301014501F00003B60000422F7B43004102C700000000F100000000000000011733F8800E0000000000000000000000000000000000080301014501F00003B60000422F6F43005002C700000000F100005852000000011733F8586A0000000000000000000000000000000000080301014501F00003B60000422F4F43004002C700000000F100005852000000011733F830C20000000000000000000000000000000000080301014501F00003B60000422F7643004102C700000000F100005852001200004EC8"));

        networkStream.Close();
        tcpClient.Close();
    }


    private static void SimulateMeitrack()
    {
        TcpClient tcpClient = new();
        tcpClient.Connect(IPAddress.Loopback, 7001);
        NetworkStream networkStream = tcpClient.GetStream();


        while (true)
        {
            string date = DateTime.UtcNow.ToString("yyMMddHHmmss");

            var location = GetRandomLocation();

            var text =
                $"$$F142,123456789012345,AAA,35,{location.Item1.ToString("F6", CultureInfo.InvariantCulture)},{location.Item2.ToString("F6", CultureInfo.InvariantCulture)},{date},A,5,30,0,147,2.5,475,56364283,8983665,123|4|0000|0000,0421,0200|000E||02EF|00FC,*7E";

            networkStream.Write(Encoding.UTF8.GetBytes(text));

            Thread.Sleep(5000);
        }
    }

    private static (double, double) GetRandomLocation()
    {
        Random rand = new Random();

        // Generate a random latitude between 46.7662 and 46.7781 degrees (the latitude range of the center of Cluj-Napoca)
        double lat = rand.NextDouble() * 0.0119 + 46.7662;

        // Generate a random longitude between 23.5896 and 23.6162 degrees (the longitude range of the center of Cluj-Napoca)
        double lon = rand.NextDouble() * 0.0266 + 23.5896;

        return (lat, lon);
    }
}